<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Health Clinic Bhopal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #0f766e 0%, #0d9488 100%);
        }

        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        /* Cool Animations */
        @keyframes blob {
            0% {
                transform: translate(0px, 0px) scale(1);
            }

            33% {
                transform: translate(30px, -50px) scale(1.1);
            }

            66% {
                transform: translate(-20px, 20px) scale(0.9);
            }

            100% {
                transform: translate(0px, 0px) scale(1);
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        @keyframes float-delayed {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-15px);
            }
        }

        @keyframes float-slow {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-blob {
            animation: blob 7s infinite;
        }

        .animation-delay-2000 {
            animation-delay: 2s;
        }

        .animation-delay-4000 {
            animation-delay: 4s;
        }

        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        .animate-float-delayed {
            animation: float-delayed 8s ease-in-out infinite;
            animation-delay: 2s;
        }

        .animate-float-slow {
            animation: float-slow 10s ease-in-out infinite;
            animation-delay: 4s;
        }

        .animate-fade-in-up {
            animation: fade-in-up 1s ease-out forwards;
        }

        /* Grid Background */
        .bg-grid-white\/\[0\.02\] {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32' fill='none' stroke='rgb(255 255 255 / 0.02)'%3e%3cpath d='m0 .5h32m-32 32v-32'/%3e%3c/svg%3e");
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-50 to-gray-100 text-gray-800 min-h-screen">
    <div class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="glass-effect border-b border-white/20 sticky top-0 z-50">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 gradient-bg rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z">
                                </path>
                            </svg>
                        </div>
                        <h1 class="text-2xl font-bold text-teal-700">AI Health Clinic Bhopal</h1>
                    </div>
                    <nav>
                        <a href="./dashboard.html"
                            class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white/80 hover:bg-white rounded-lg border border-gray-200 hover:border-teal-300 transition-all duration-200 shadow-sm hover:shadow-md">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                </path>
                            </svg>
                            View Dashboard
                        </a>
                    </nav>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="max-w-4xl mx-auto">
                <!-- Hero Section -->
                <div class="text-center mb-12">
                    <div
                        class="inline-flex items-center px-4 py-2 bg-teal-50 text-teal-700 rounded-full text-sm font-medium mb-6">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        AI-Powered Healthcare Assistant
                    </div>
                    <h2 class="text-4xl md:text-6xl font-extrabold text-gray-900 mb-6 leading-tight">
                        Welcome to Your Personal
                        <span class="gradient-bg bg-clip-text text-transparent"> AI Health Assistant</span>
                    </h2>
                    <p class="text-xl text-gray-600 max-w-3xl mx-auto mb-8 leading-relaxed">
                        Start a conversation with our advanced AI assistant. Discuss your symptoms, ask health
                        questions, and book appointments.
                        Your conversation will be analyzed and saved to your personal dashboard.
                    </p>
                </div>

                <!-- Full-Screen AI Chat Interface -->
                <div
                    class="relative w-full min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 rounded-3xl overflow-hidden shadow-2xl border border-purple-500/20 mb-12">
                    <!-- Animated Background -->
                    <div class="absolute inset-0 overflow-hidden">
                        <div class="absolute -inset-10 opacity-30">
                            <div
                                class="absolute top-1/4 left-1/4 w-72 h-72 bg-purple-500 rounded-full mix-blend-multiply filter blur-xl animate-blob">
                            </div>
                            <div
                                class="absolute top-1/3 right-1/4 w-72 h-72 bg-yellow-500 rounded-full mix-blend-multiply filter blur-xl animate-blob animation-delay-2000">
                            </div>
                            <div
                                class="absolute bottom-1/4 left-1/3 w-72 h-72 bg-pink-500 rounded-full mix-blend-multiply filter blur-xl animate-blob animation-delay-4000">
                            </div>
                        </div>

                        <!-- Grid Pattern -->
                        <div class="absolute inset-0 bg-grid-white/[0.02] bg-[size:50px_50px]"></div>

                        <!-- Floating Particles -->
                        <div class="absolute inset-0">
                            <div class="absolute top-20 left-20 w-2 h-2 bg-white/20 rounded-full animate-float"></div>
                            <div
                                class="absolute top-40 right-32 w-1 h-1 bg-purple-400/30 rounded-full animate-float-delayed">
                            </div>
                            <div
                                class="absolute bottom-32 left-1/4 w-3 h-3 bg-pink-400/20 rounded-full animate-float-slow">
                            </div>
                            <div class="absolute top-1/2 right-20 w-2 h-2 bg-yellow-400/25 rounded-full animate-float">
                            </div>
                        </div>
                    </div>

                    <!-- Header Section -->
                    <div class="relative z-10 px-8 py-6 bg-black/20 backdrop-blur-sm border-b border-white/10">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <div
                                        class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center shadow-lg">
                                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z">
                                            </path>
                                        </svg>
                                    </div>
                                    <div
                                        class="absolute -top-1 -right-1 w-4 h-4 bg-green-400 rounded-full border-2 border-white animate-pulse">
                                    </div>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-white">AI Health Assistant</h3>
                                    <p class="text-purple-200 text-sm">Advanced Medical Consultation AI</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div
                                    class="flex items-center space-x-2 bg-green-500/20 px-3 py-1 rounded-full border border-green-500/30">
                                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                    <span class="text-green-300 text-sm font-medium">Online</span>
                                </div>
                                <div class="text-white/60 text-sm">
                                    <span id="current-time"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Chat Area - REDESIGNED FOR BETTER CONVERSATION VIEW -->
                    <div class="relative z-10 flex flex-col h-[800px]">
                        <!-- Large Chat Messages Area -->
                        <div class="flex-1 p-6 overflow-y-auto bg-black/10 backdrop-blur-sm">
                            <div id="chat-messages" class="space-y-8 max-w-5xl mx-auto">
                                <!-- Welcome Message -->
                                <div class="flex items-start space-x-6 opacity-0 animate-fade-in-up">
                                    <div
                                        class="flex-shrink-0 w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center shadow-xl">
                                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z">
                                            </path>
                                        </svg>
                                    </div>
                                    <div
                                        class="flex-1 bg-white/15 backdrop-blur-sm rounded-3xl p-8 border border-white/30 shadow-2xl">
                                        <div class="flex items-center justify-between mb-4">
                                            <span class="text-purple-300 text-lg font-bold">🤖 AI Health
                                                Assistant</span>
                                            <span class="text-white/60 text-sm">Just now</span>
                                        </div>
                                        <p class="text-white text-xl leading-relaxed font-medium">
                                            👋 Hello! I'm your AI Health Assistant. I'm here to help you with medical
                                            consultations,
                                            symptom analysis, and appointment scheduling.
                                        </p>
                                        <p class="text-white/90 text-lg mt-4">
                                            🎤 Click the <strong>Voice Chat</strong> button below to start speaking, or
                                            type your message!
                                        </p>
                                        <div class="mt-6 flex items-center space-x-3">
                                            <div class="flex space-x-2">
                                                <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                                                <div class="w-3 h-3 bg-blue-400 rounded-full animate-pulse"
                                                    style="animation-delay: 0.2s"></div>
                                                <div class="w-3 h-3 bg-purple-400 rounded-full animate-pulse"
                                                    style="animation-delay: 0.4s"></div>
                                            </div>
                                            <span class="text-green-300 text-lg font-semibold">Ready to help you!</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- COMPACT Chat Input Interface -->
                        <div class="px-6 pb-6">
                            <div id="chat-widget-container" class="max-w-5xl mx-auto">
                                <!-- Streamlined Input Area -->
                                <div
                                    class="bg-black/25 backdrop-blur-xl rounded-3xl border border-white/30 overflow-hidden shadow-2xl">
                                    <!-- Input Controls -->
                                    <div class="p-6">
                                        <!-- Voice and Text Input Row -->
                                        <div class="flex items-center space-x-4">
                                            <!-- Voice Chat Button -->
                                            <button id="start-voice-chat"
                                                class="group relative bg-gradient-to-r from-purple-600 via-pink-600 to-yellow-500 hover:from-purple-700 hover:via-pink-700 hover:to-yellow-600 text-white font-bold py-4 px-6 rounded-2xl shadow-2xl transform hover:scale-105 transition-all duration-300 flex items-center space-x-3">
                                                <!-- Animated Ring -->
                                                <div
                                                    class="absolute -inset-1 bg-gradient-to-r from-purple-600 via-pink-600 to-yellow-500 rounded-2xl blur opacity-30 group-hover:opacity-50 animate-pulse">
                                                </div>

                                                <!-- Button Content -->
                                                <div class="relative flex items-center space-x-3">
                                                    <div class="relative">
                                                        <svg class="w-7 h-7" fill="none" stroke="currentColor"
                                                            viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z">
                                                            </path>
                                                        </svg>
                                                        <div
                                                            class="absolute -inset-1 bg-white/20 rounded-full animate-ping">
                                                        </div>
                                                    </div>
                                                    <span class="font-bold text-lg">🎤 Voice Chat</span>
                                                </div>
                                            </button>

                                            <!-- OR Divider -->
                                            <div class="flex items-center">
                                                <div class="w-12 h-px bg-white/30"></div>
                                                <span class="px-3 text-white/70 text-sm font-medium">OR</span>
                                                <div class="w-12 h-px bg-white/30"></div>
                                            </div>

                                            <!-- Text Input Area -->
                                            <div class="flex-1 relative">
                                                <textarea id="chat-input"
                                                    placeholder="Type your health question or describe your symptoms..."
                                                    class="w-full bg-white/15 border border-white/30 rounded-2xl px-6 py-4 text-white text-lg placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:border-transparent resize-none"
                                                    rows="2"></textarea>
                                                <div class="absolute bottom-3 right-3">
                                                    <button id="send-text-btn"
                                                        class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white p-3 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg">
                                                        <svg class="w-6 h-6" fill="none" stroke="currentColor"
                                                            viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2" d="12 19l9 2-9-18-9 18 9-2zm0 0v-8">
                                                            </path>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Quick Action Buttons -->
                                        <div class="flex flex-wrap gap-3 mt-4">
                                            <button
                                                class="quick-action-btn bg-white/15 hover:bg-white/25 text-white px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200 border border-white/20"
                                                data-text="I have a headache and fever">
                                                🤒 Fever & Headache
                                            </button>
                                            <button
                                                class="quick-action-btn bg-white/15 hover:bg-white/25 text-white px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200 border border-white/20"
                                                data-text="I need to book an appointment">
                                                📅 Book Appointment
                                            </button>
                                            <button
                                                class="quick-action-btn bg-white/15 hover:bg-white/25 text-white px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200 border border-white/20"
                                                data-text="What are my medication options?">
                                                💊 Medications
                                            </button>
                                            <button
                                                class="quick-action-btn bg-white/15 hover:bg-white/25 text-white px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200 border border-white/20"
                                                data-text="I have chest pain">
                                                ❤️ Chest Pain
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conversation Transcript Display -->
                <div id="transcript-container"
                    class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden mb-8 hidden">
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-teal-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                                Conversation Transcript
                            </h3>
                            <div class="flex items-center space-x-2">
                                <span
                                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <div class="w-2 h-2 bg-green-400 rounded-full mr-1 animate-pulse"></div>
                                    Live
                                </span>
                                <button id="clear-transcript"
                                    class="text-sm text-gray-500 hover:text-red-600 transition-colors px-2 py-1 rounded hover:bg-red-50">
                                    Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="transcript-content"
                        class="max-h-80 overflow-y-auto p-6 bg-gradient-to-b from-white to-gray-50">
                        <!-- Transcript will be injected here -->
                    </div>
                </div>

                <!-- Analysis Section -->
                <div class="text-center">
                    <button id="analyze-btn"
                        class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-teal-600 to-teal-700 text-white font-semibold rounded-xl shadow-lg hover:from-teal-700 hover:to-teal-800 transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z">
                            </path>
                        </svg>
                        Analyze Conversation & Save to Dashboard
                    </button>
                    <p id="status-text" class="text-gray-600 mt-4 min-h-[1.5rem] flex items-center justify-center">
                        <!-- Status updates will appear here -->
                    </p>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200 py-6">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center text-gray-600">
                    <p>&copy; 2024 AI Health Clinic Bhopal. Your health, our priority.</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- ElevenLabs Conversational AI Widget (Functional Size, Less Prominent) -->
    <div id="elevenlabs-widget-container"
        style="position: fixed; bottom: 20px; right: 20px; z-index: 1000; width: 350px; height: 450px;">
        <div style="position: relative;">
            <button id="close-voice-widget"
                style="position: absolute; top: -8px; right: -8px; z-index: 1001; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">×</button>
            <elevenlabs-convai agent-id="agent_2201k431qr7zen8vang03mb25kdb"></elevenlabs-convai>
        </div>
    </div>
    <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>

    <!-- CSS for integrated widget -->
    <style>
        /* Style the ElevenLabs widget - functional size but less prominent */
        elevenlabs-convai {
            width: 100% !important;
            height: 100% !important;
            border-radius: 12px !important;
            box-shadow: 0 6px 20px -6px rgba(0, 0, 0, 0.15) !important;
            border: 1px solid rgba(139, 92, 246, 0.25) !important;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(236, 72, 153, 0.08)) !important;
            backdrop-filter: blur(8px) !important;
            transform: scale(0.95) !important;
            opacity: 0.92 !important;
        }

        /* Ensure our custom interface stays visible */
        #chat-widget-container>div {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Smooth scrolling for chat messages */
        #chat-messages {
            scroll-behavior: smooth;
        }

        /* Hide widget initially, show when voice is activated - functional but less prominent */
        #elevenlabs-widget-container {
            opacity: 0;
            transform: translateY(60px) scale(0.9);
            transition: all 0.4s ease;
        }

        #elevenlabs-widget-container.active {
            opacity: 0.92;
            transform: translateY(0) scale(0.95);
        }

        /* Hover effect ONLY when widget is active */
        #elevenlabs-widget-container.active:hover {
            opacity: 1 !important;
            transform: translateY(0) scale(1) !important;
            transition: all 0.2s ease !important;
        }

        /* Focus effect ONLY when widget is active */
        #elevenlabs-widget-container.active:focus-within {
            opacity: 1 !important;
            transform: translateY(0) scale(1) !important;
        }

        /* Ensure inactive widget stays hidden even on hover */
        #elevenlabs-widget-container:not(.active):hover {
            opacity: 0 !important;
            transform: translateY(60px) scale(0.9) !important;
        }
    </style>

    <!-- ElevenLabs Integration and Local Analysis -->
    <script>
        // --- Configuration ---
        const elevenLabsApiKey = "sk_7f57d02d8b0ff1c8c0aa89b4de6947411266ae60448b5ea0";
        const agentId = "agent_2201k431qr7zen8vang03mb25kdb";

        // --- UI Elements ---
        const analyzeBtn = document.getElementById('analyze-btn');
        const statusText = document.getElementById('status-text');
        const transcriptContainer = document.getElementById('transcript-container');
        const transcriptContent = document.getElementById('transcript-content');
        const clearTranscriptBtn = document.getElementById('clear-transcript');
        const chatWidgetContainer = document.getElementById('chat-widget-container');

        // --- ElevenLabs Widget Management ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize branding removal
            initializeBrandingRemoval();

            // Initialize UI event listeners
            initializeEventListeners();

            // Initialize widget but keep our custom interface
            setTimeout(() => {
                initializeWidgetForVoice();

                // Start monitoring for voice conversations
                startVoiceConversationMonitoring();
            }, 2000);
        });

        function initializeBrandingRemoval() {
            const removeBranding = () => {
                const widget = document.querySelector('elevenlabs-convai');
                if (widget && widget.shadowRoot) {
                    // Try multiple selectors to catch the branding element
                    const selectors = [
                        'p.whitespace-nowrap.text-[10px][class*="translate-y"]',
                        'p[class*="whitespace-nowrap"][class*="text-"]',
                        'p:contains("11Labs")',
                        'p:contains("ElevenLabs")',
                        '[class*="branding"]',
                        'p.text-xs',
                        'p[class*="text-[10px]"]',
                        'a[href*="elevenlabs"]',
                        '[class*="powered"]'
                    ];

                    let removed = false;
                    selectors.forEach(selector => {
                        try {
                            const elements = widget.shadowRoot.querySelectorAll(selector);
                            elements.forEach(element => {
                                if (element && (
                                    element.textContent.includes('11Labs') ||
                                    element.textContent.includes('ElevenLabs') ||
                                    element.textContent.includes('Powered by') ||
                                    element.href && element.href.includes('elevenlabs')
                                )) {
                                    element.remove();
                                    removed = true;
                                }
                            });
                        } catch (e) {
                            // Ignore selector errors
                        }
                    });

                    // Additional approach: hide elements with specific text content
                    const allElements = widget.shadowRoot.querySelectorAll('p, span, div, a');
                    allElements.forEach(el => {
                        if (el.textContent && (
                            el.textContent.includes('11Labs') ||
                            el.textContent.includes('ElevenLabs') ||
                            el.textContent.includes('Powered by')
                        )) {
                            el.style.display = 'none';
                            removed = true;
                        }
                    });

                    return removed;
                }
                return false;
            };

            // Initial attempt
            setTimeout(() => {
                removeBranding();
            }, 1000);

            // Polling approach with multiple attempts
            let attempts = 0;
            const maxAttempts = 30;
            const interval = setInterval(() => {
                attempts++;
                if (removeBranding() || attempts >= maxAttempts) {
                    clearInterval(interval);
                }
            }, 500);

            // Observer approach for dynamic content
            const observer = new MutationObserver(() => {
                removeBranding();
            });

            // Start observing once widget is available
            const checkWidget = setInterval(() => {
                const widget = document.querySelector('elevenlabs-convai');
                if (widget && widget.shadowRoot) {
                    observer.observe(widget.shadowRoot, {
                        childList: true,
                        subtree: true
                    });
                    clearInterval(checkWidget);
                }
            }, 100);

            // Cleanup observer after 60 seconds
            setTimeout(() => {
                observer.disconnect();
            }, 60000);
        }

        function initializeWidgetForVoice() {
            const widget = document.querySelector('elevenlabs-convai');
            if (widget) {
                // Just ensure the widget is ready for voice interaction
                // Don't move it to our container, keep it hidden but functional
                console.log('ElevenLabs widget initialized for voice functionality');

                // Add comprehensive event listeners to capture voice conversations
                try {
                    // Listen for conversation events from ElevenLabs
                    widget.addEventListener('conversationStarted', () => {
                        addMessageToChat('ai', '🎤 **Voice conversation started!** I can hear you clearly. Your voice messages will appear here.');
                    });

                    // Capture user speech (when user speaks)
                    widget.addEventListener('userSpeechStart', () => {
                        showTypingIndicator('user');
                    });

                    widget.addEventListener('userSpeechEnd', (event) => {
                        hideTypingIndicator();
                        if (event.detail && event.detail.transcript) {
                            addMessageToChat('user', `🎤 ${event.detail.transcript}`);
                            addToTranscript(`User (Voice): ${event.detail.transcript}`);
                        }
                    });

                    // Capture AI responses (when AI speaks back)
                    widget.addEventListener('aiResponseStart', () => {
                        showTypingIndicator('ai');
                    });

                    widget.addEventListener('aiResponseEnd', (event) => {
                        hideTypingIndicator();
                        if (event.detail && event.detail.response) {
                            addMessageToChat('ai', `🔊 ${event.detail.response}`);
                            addToTranscript(`AI (Voice): ${event.detail.response}`);
                        }
                    });

                    // Generic message events (fallback)
                    widget.addEventListener('message', (event) => {
                        if (event.detail) {
                            const { type, content, sender } = event.detail;
                            if (content) {
                                const icon = sender === 'user' ? '🎤' : '🔊';
                                addMessageToChat(sender || 'ai', `${icon} ${content}`);
                                addToTranscript(`${sender === 'user' ? 'User' : 'AI'} (Voice): ${content}`);
                            }
                        }
                    });

                    widget.addEventListener('conversationEnded', () => {
                        addMessageToChat('ai', '🎤 **Voice conversation ended.** All voice messages have been saved to your conversation history. Feel free to start another voice session or continue with text.');

                        // Reset voice button
                        const startBtn = document.getElementById('start-voice-chat');
                        if (startBtn) {
                            startBtn.innerHTML = `
                                <div class="relative flex items-center space-x-3">
                                    <div class="relative">
                                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                        </svg>
                                        <div class="absolute -inset-1 bg-white/20 rounded-full animate-ping"></div>
                                    </div>
                                    <span class="font-bold text-lg">🎤 Voice Chat</span>
                                </div>
                            `;
                            startBtn.style.background = '';
                            startBtn.classList.remove('opacity-75');
                        }
                    });

                    // Monitor widget for any DOM changes to capture conversations
                    const observer = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                            if (mutation.type === 'childList') {
                                // Look for new message elements in the widget
                                mutation.addedNodes.forEach((node) => {
                                    if (node.nodeType === Node.ELEMENT_NODE) {
                                        captureWidgetMessages(node);
                                    }
                                });
                            }
                        });
                    });

                    // Start observing the widget for changes
                    if (widget.shadowRoot) {
                        observer.observe(widget.shadowRoot, {
                            childList: true,
                            subtree: true
                        });
                    } else {
                        observer.observe(widget, {
                            childList: true,
                            subtree: true
                        });
                    }

                } catch (error) {
                    console.log('Widget event listeners not available, using fallback monitoring:', error);

                    // Fallback: Monitor widget for text changes
                    setInterval(() => {
                        monitorWidgetForConversations();
                    }, 2000);
                }
            }
        }

        // --- Voice Conversation Capture Functions ---
        function captureWidgetMessages(node) {
            // Look for message-like elements in the widget
            const messageSelectors = [
                '[class*="message"]',
                '[class*="chat"]',
                '[class*="conversation"]',
                'p', 'div[class*="text"]',
                '[role="log"]'
            ];

            messageSelectors.forEach(selector => {
                const messages = node.querySelectorAll ? node.querySelectorAll(selector) : [];
                messages.forEach(msg => {
                    const text = msg.textContent?.trim();
                    if (text && text.length > 3 && !text.includes('ElevenLabs') && !text.includes('Powered by')) {
                        // Determine if it's user or AI message based on context
                        const isUserMessage = msg.classList.contains('user') ||
                            msg.closest('[class*="user"]') ||
                            text.toLowerCase().includes('you said') ||
                            text.toLowerCase().includes('user:');

                        const sender = isUserMessage ? 'user' : 'ai';
                        const icon = isUserMessage ? '🎤' : '🔊';

                        // Check if we already added this message
                        if (!msg.dataset.captured) {
                            addMessageToChat(sender, `${icon} ${text}`);
                            addToTranscript(`${isUserMessage ? 'User' : 'AI'} (Voice): ${text}`);
                            msg.dataset.captured = 'true';
                        }
                    }
                });
            });
        }

        let lastWidgetContent = '';
        function monitorWidgetForConversations() {
            const widget = document.querySelector('elevenlabs-convai');
            if (!widget) return;

            // Get all text content from the widget
            const currentContent = widget.textContent || '';

            if (currentContent !== lastWidgetContent && currentContent.length > lastWidgetContent.length) {
                // New content detected
                const newContent = currentContent.substring(lastWidgetContent.length).trim();

                if (newContent && newContent.length > 3 &&
                    !newContent.includes('ElevenLabs') &&
                    !newContent.includes('Powered by') &&
                    !newContent.includes('Loading')) {

                    // Try to determine if it's user or AI
                    const isUserMessage = newContent.toLowerCase().includes('you:') ||
                        newContent.toLowerCase().includes('user:') ||
                        newContent.startsWith('"');

                    const sender = isUserMessage ? 'user' : 'ai';
                    const icon = isUserMessage ? '🎤' : '🔊';

                    addMessageToChat(sender, `${icon} ${newContent}`);
                    addToTranscript(`${isUserMessage ? 'User' : 'AI'} (Voice): ${newContent}`);
                }

                lastWidgetContent = currentContent;
            }
        }

        // Enhanced typing indicator for voice
        function showTypingIndicator(sender = 'ai') {
            hideTypingIndicator(); // Remove any existing indicator

            const chatMessages = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'flex items-start space-x-6 opacity-0 animate-fade-in-up mb-6';

            const isUser = sender === 'user';
            const icon = isUser ? '🎤' : '🔊';
            const label = isUser ? 'Speaking...' : 'AI Responding...';
            const bgColor = isUser ? 'from-blue-500 to-cyan-500' : 'from-purple-500 to-pink-500';

            typingDiv.innerHTML = `
                <div class="flex-shrink-0 w-16 h-16 bg-gradient-to-r ${bgColor} rounded-2xl flex items-center justify-center shadow-xl">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                </div>
                <div class="flex-1 bg-white/15 backdrop-blur-sm rounded-3xl p-8 border border-white/30 shadow-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <span class="${isUser ? 'text-cyan-300' : 'text-purple-300'} text-lg font-bold">${icon} ${isUser ? 'You' : 'AI Assistant'}</span>
                        <span class="text-white/60 text-sm">${label}</span>
                    </div>
                    <div class="flex space-x-2">
                        <div class="w-4 h-4 bg-purple-400 rounded-full animate-bounce"></div>
                        <div class="w-4 h-4 bg-pink-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-4 h-4 bg-yellow-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
            `;

            chatMessages.appendChild(typingDiv);
            setTimeout(() => {
                typingDiv.classList.remove('opacity-0');
                scrollToBottom();
            }, 100);
        }

        function moveWidgetToContainer() {
            const widget = document.querySelector('elevenlabs-convai');
            const container = document.getElementById('chat-widget-container');

            if (widget && container) {
                // Clear loading state
                container.innerHTML = '';

                // Create full-screen integrated widget container
                const widgetWrapper = document.createElement('div');
                widgetWrapper.className = 'max-w-4xl mx-auto';

                // Create the main widget area with futuristic design
                const mainArea = document.createElement('div');
                mainArea.className = 'relative bg-black/20 backdrop-blur-xl rounded-3xl border border-white/20 overflow-hidden';
                mainArea.innerHTML = `
                    <!-- Animated Border -->
                    <div class="absolute inset-0 rounded-3xl bg-gradient-to-r from-purple-500 via-pink-500 to-yellow-500 opacity-20 animate-pulse"></div>
                    <div class="absolute inset-[1px] rounded-3xl bg-black/40 backdrop-blur-xl"></div>
                    
                    <!-- Widget Header -->
                    <div class="relative z-10 px-6 py-4 border-b border-white/10">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                                <span class="text-white font-medium">Voice Assistant Active</span>
                            </div>
                            <div class="flex items-center space-x-2 text-white/60 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                                <span>Secure Connection</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Widget Content Area -->
                    <div class="relative z-10 p-8" id="widget-content-area">
                        <!-- Widget will be placed here -->
                    </div>
                `;

                // Add the widget to the content area
                const contentArea = mainArea.querySelector('#widget-content-area');
                contentArea.appendChild(widget);
                widgetWrapper.appendChild(mainArea);
                container.appendChild(widgetWrapper);

                // Style the widget for full integration
                widget.style.width = '100%';
                widget.style.minHeight = '500px';
                widget.style.borderRadius = '20px';
                widget.style.overflow = 'hidden';
                widget.style.background = 'transparent';
                widget.style.border = 'none';

                // Add enhanced styling
                const style = document.createElement('style');
                style.textContent = `
                    /* Full-screen widget integration */
                    elevenlabs-convai {
                        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%) !important;
                        backdrop-filter: blur(10px) !important;
                        border: 1px solid rgba(255,255,255,0.2) !important;
                        border-radius: 20px !important;
                        box-shadow: 
                            0 25px 50px -12px rgba(0, 0, 0, 0.25),
                            inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
                        transition: all 0.3s ease !important;
                    }
                    
                    elevenlabs-convai:hover {
                        transform: translateY(-2px) !important;
                        box-shadow: 
                            0 35px 60px -12px rgba(0, 0, 0, 0.3),
                            inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
                    }
                    
                    /* Widget content styling */
                    elevenlabs-convai::part(container) {
                        background: transparent !important;
                        color: white !important;
                    }
                    
                    /* Animation for widget appearance */
                    #chat-widget-container {
                        animation: widgetSlideIn 1s ease-out forwards;
                    }
                    
                    @keyframes widgetSlideIn {
                        from {
                            opacity: 0;
                            transform: translateY(50px) scale(0.9);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0) scale(1);
                        }
                    }
                    
                    /* Glowing effect */
                    .max-w-4xl > div {
                        position: relative;
                    }
                    
                    .max-w-4xl > div::before {
                        content: '';
                        position: absolute;
                        inset: -2px;
                        background: linear-gradient(45deg, #8b5cf6, #ec4899, #f59e0b, #10b981);
                        border-radius: 24px;
                        opacity: 0.3;
                        filter: blur(10px);
                        z-index: -1;
                        animation: glow 3s ease-in-out infinite alternate;
                    }
                    
                    @keyframes glow {
                        from { opacity: 0.3; }
                        to { opacity: 0.6; }
                    }
                `;
                document.head.appendChild(style);

                console.log('ElevenLabs widget integrated into full-screen interface');

                // Add success notification with cool effect
                setTimeout(() => {
                    showConversationStatus('🚀 AI Assistant Ready - Start Speaking!', 'ready');
                    addWelcomeMessage();
                }, 1000);
            }
        }

        // Add welcome message to chat
        function addWelcomeMessage() {
            const chatMessages = document.getElementById('chat-messages');
            const welcomeMsg = chatMessages.querySelector('.animate-fade-in-up');
            if (welcomeMsg) {
                welcomeMsg.style.animationDelay = '0.5s';
                welcomeMsg.classList.add('opacity-100');
            }
        }

        function initializeEventListeners() {
            // Analyze button click handler
            analyzeBtn.addEventListener('click', handleAnalyzeClick);

            // Clear transcript button
            clearTranscriptBtn.addEventListener('click', () => {
                transcriptContent.innerHTML = '';
                transcriptContainer.classList.add('hidden');
            });

            // Start Voice Chat button (with toggle functionality)
            const startVoiceChatBtn = document.getElementById('start-voice-chat');
            if (startVoiceChatBtn) {
                startVoiceChatBtn.addEventListener('click', () => {
                    const widgetContainer = document.getElementById('elevenlabs-widget-container');

                    // Toggle voice widget
                    if (widgetContainer && widgetContainer.classList.contains('active')) {
                        // Close voice widget
                        deactivateVoiceChat();
                    } else {
                        // Open voice widget
                        activateVoiceChat();
                    }
                });
            }

            // Text input functionality
            const chatInput = document.getElementById('chat-input');
            const sendTextBtn = document.getElementById('send-text-btn');

            if (chatInput && sendTextBtn) {
                // Send button click
                sendTextBtn.addEventListener('click', () => {
                    sendTextMessage();
                });

                // Enter key to send (Shift+Enter for new line)
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendTextMessage();
                    }
                });
            }

            // Quick action buttons
            const quickActionBtns = document.querySelectorAll('.quick-action-btn');
            quickActionBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const text = btn.getAttribute('data-text');
                    if (text && chatInput) {
                        chatInput.value = text;
                        chatInput.focus();
                        // Auto-send the quick action
                        setTimeout(() => sendTextMessage(), 100);
                    }
                });
            });

            // Close voice widget button
            const closeVoiceBtn = document.getElementById('close-voice-widget');
            if (closeVoiceBtn) {
                closeVoiceBtn.addEventListener('click', () => {
                    deactivateVoiceChat();
                });
            }
        }

        // --- IMPROVED Voice Chat Activation ---
        function activateVoiceChat() {
            showNotification('🎤 Activating voice assistant...', 'info');

            // Show the ElevenLabs widget
            const widgetContainer = document.getElementById('elevenlabs-widget-container');
            if (widgetContainer) {
                widgetContainer.classList.add('active');
            }

            // Update button state immediately
            const startBtn = document.getElementById('start-voice-chat');
            if (startBtn) {
                startBtn.innerHTML = `
                    <div class="relative flex items-center space-x-3">
                        <div class="w-4 h-4 bg-green-400 rounded-full animate-pulse"></div>
                        <span class="font-bold text-lg">🎤 Close Voice</span>
                    </div>
                `;
                startBtn.style.background = 'linear-gradient(to right, #10b981, #059669)';
            }

            // Wait for widget to load and then setup bidirectional sync
            setTimeout(() => {
                setupElevenLabsIntegration();
                monitorVoiceWidgetForMessages();
            }, 1500);

            // Add message to chat
            addMessageToChat('ai', '🎤 **Voice chat is now active!**\n\n**Features:**\n• Voice widget in bottom-right corner\n• **Bidirectional sync**: Text messages sent to ElevenLabs agent\n• **Voice responses**: Agent responses appear in main chat\n• **Toggle button**: Click Voice button again to close\n• **Auto-scroll**: Chat scrolls to new messages\n\n**You can now use both voice and text with the same agent!**');

            showNotification('✅ Voice widget activated! Click Voice button again to close.', 'success');
        }

        // --- Enhanced Voice Chat Deactivation ---
        function deactivateVoiceChat() {
            console.log('🔴 Deactivating voice chat...');

            // First, aggressively try to end the voice call
            const widget = document.querySelector('elevenlabs-convai');
            if (widget) {
                try {
                    // Method 1: Try ElevenLabs API methods
                    const apiMethods = ['endCall', 'disconnect', 'stop', 'terminate', 'close', 'hangup'];
                    let callEnded = false;

                    for (const method of apiMethods) {
                        if (widget[method] && typeof widget[method] === 'function') {
                            widget[method]();
                            console.log(`✅ Ended call via ${method}()`);
                            callEnded = true;
                            break;
                        }
                    }

                    // Method 2: Try to find and click end/stop buttons
                    if (!callEnded) {
                        const buttonSelectors = [
                            '[aria-label*="end"]', '[aria-label*="stop"]', '[aria-label*="hang"]',
                            '[title*="end"]', '[title*="stop"]', '[title*="hang"]',
                            '.end-call', '.stop-call', '.hang-up', '.disconnect',
                            'button[class*="end"]', 'button[class*="stop"]', 'button[class*="hang"]'
                        ];

                        for (const selector of buttonSelectors) {
                            const btn = widget.shadowRoot?.querySelector(selector) || widget.querySelector(selector);
                            if (btn) {
                                btn.click();
                                console.log(`✅ Clicked ${selector} button`);
                                callEnded = true;
                                break;
                            }
                        }
                    }

                    // Method 3: Try to remove/hide the widget completely to force stop
                    if (!callEnded) {
                        widget.style.display = 'none';
                        setTimeout(() => {
                            widget.style.display = '';
                        }, 1000);
                        console.log('⚠️ Forced widget hide to stop call');
                    }

                } catch (error) {
                    console.log('⚠️ Error ending call:', error);
                }
            }

            // Hide the widget container with proper state management
            const widgetContainer = document.getElementById('elevenlabs-widget-container');
            if (widgetContainer) {
                widgetContainer.classList.remove('active');
                // Remove hover effects when closed
                widgetContainer.style.pointerEvents = 'none';
                setTimeout(() => {
                    widgetContainer.style.pointerEvents = '';
                }, 500);
            }

            // Reset voice button
            const startBtn = document.getElementById('start-voice-chat');
            if (startBtn) {
                startBtn.innerHTML = `
                    <div class="relative flex items-center space-x-3">
                        <div class="relative">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                            </svg>
                            <div class="absolute -inset-1 bg-white/20 rounded-full animate-ping"></div>
                        </div>
                        <span class="font-bold text-lg">🎤 Voice Chat</span>
                    </div>
                `;
                startBtn.style.background = '';
            }

            // Stop monitoring
            if (voiceMonitoringObserver) {
                voiceMonitoringObserver.disconnect();
                voiceMonitoringObserver = null;
            }

            // Clear tracking variables
            processedMessages.clear();
            lastUserMessage = '';

            addMessageToChat('ai', '🔴 **Voice call ended and widget closed.** The conversation has been terminated. Click Voice Chat to start fresh!');
            showNotification('Voice call terminated and widget closed', 'success');
        }

        // --- ElevenLabs Widget Integration Setup ---
        function setupElevenLabsIntegration() {
            const widget = document.querySelector('elevenlabs-convai');
            if (!widget) {
                console.log('ElevenLabs widget not found, retrying...');
                setTimeout(setupElevenLabsIntegration, 1000);
                return;
            }

            // Listen for widget ready event
            widget.addEventListener('ready', () => {
                console.log('✅ ElevenLabs widget is ready for integration');
            });

            // Try to access widget API when it's loaded
            const checkWidgetAPI = () => {
                if (widget.convai || widget.sendTextMessage) {
                    console.log('✅ ElevenLabs widget API is available');
                    return true;
                }
                return false;
            };

            // Check periodically for API availability
            const apiCheckInterval = setInterval(() => {
                if (checkWidgetAPI()) {
                    clearInterval(apiCheckInterval);
                }
            }, 500);

            // Clear interval after 10 seconds to avoid infinite checking
            setTimeout(() => clearInterval(apiCheckInterval), 10000);
        }

        // --- Enhanced Voice Conversation Monitoring ---
        let voiceMonitoringObserver = null;

        function startVoiceConversationMonitoring() {
            // Clean up any existing monitoring
            if (voiceMonitoringObserver) {
                voiceMonitoringObserver.disconnect();
            }

            // Start the new bidirectional monitoring
            voiceMonitoringObserver = monitorVoiceWidgetForMessages();

            // Stop monitoring when voice widget is closed
            const closeBtn = document.getElementById('close-voice-widget');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    if (voiceMonitoringObserver) {
                        voiceMonitoringObserver.disconnect();
                        voiceMonitoringObserver = null;
                        addMessageToChat('ai', '💾 **Voice conversation saved!** All voice messages have been integrated into your conversation history.');
                    }
                });
            }
        }

        // --- Enhanced Scroll Function ---
        function scrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                const scrollToBottomInstant = () => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                };

                const scrollToBottomSmooth = () => {
                    chatMessages.scrollTo({
                        top: chatMessages.scrollHeight,
                        behavior: 'smooth'
                    });
                };

                // Immediate scroll
                scrollToBottomInstant();

                // Use requestAnimationFrame for better performance
                requestAnimationFrame(() => {
                    scrollToBottomSmooth();

                    // Additional scrolls with proper timing
                    setTimeout(scrollToBottomInstant, 100);
                    setTimeout(scrollToBottomSmooth, 300);
                    setTimeout(scrollToBottomInstant, 500);
                });
            }
        }

        // --- Text Message Handling ---
        function sendTextMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();

            if (!message) {
                showNotification('Please enter a message first', 'warning');
                return;
            }

            // Add message to chat display
            addMessageToChat('user', message);

            // Sync to voice widget if active (this will let the ElevenLabs agent respond)
            syncMessageToVoiceWidget('user', message);

            // Clear input
            chatInput.value = '';

            // Add to transcript for analysis
            addToTranscript(`User: ${message}`);

            // Note: No local AI response - we let the ElevenLabs agent handle responses
            // The agent's response will be captured by monitorVoiceWidgetForMessages()
        }

        // --- Chat Display Functions ---
        function addMessageToChat(sender, message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start space-x-6 opacity-0 animate-fade-in-up mb-6`;

            const isUser = sender === 'user';
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            messageDiv.innerHTML = `
                <div class="flex-shrink-0 w-16 h-16 ${isUser ? 'bg-gradient-to-r from-blue-500 to-cyan-500' : 'bg-gradient-to-r from-purple-500 to-pink-500'} rounded-2xl flex items-center justify-center shadow-xl">
                    ${isUser ?
                    '<svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>' :
                    '<svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>'
                }
                </div>
                <div class="flex-1 bg-white/15 backdrop-blur-sm rounded-3xl p-8 border border-white/30 shadow-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <span class="${isUser ? 'text-cyan-300' : 'text-purple-300'} text-lg font-bold">${isUser ? '👤 You' : '🤖 AI Assistant'}</span>
                        <span class="text-white/60 text-sm">${time}</span>
                    </div>
                    <p class="text-white text-xl leading-relaxed font-medium">${message}</p>
                </div>
            `;

            chatMessages.appendChild(messageDiv);

            // Animate in
            setTimeout(() => {
                messageDiv.classList.remove('opacity-0');
            }, 100);

            // Enhanced scroll to bottom with better timing
            requestAnimationFrame(() => {
                scrollToBottom();
                // Additional scroll after animation completes
                setTimeout(scrollToBottom, 200);
                setTimeout(scrollToBottom, 500);
            });
        }

        // --- Enhanced Bidirectional Sync Functions ---
        function syncMessageToVoiceWidget(sender, message) {
            const widgetContainer = document.getElementById('elevenlabs-widget-container');
            const widget = document.querySelector('elevenlabs-convai');

            // Only sync user messages to voice widget (not AI responses to avoid loops)
            if (sender !== 'user' || !widgetContainer || !widgetContainer.classList.contains('active') || !widget) {
                return;
            }

            try {
                // Wait for widget to be fully loaded
                setTimeout(() => {
                    // Method 1: Try ElevenLabs specific API
                    if (widget.sendTextMessage && typeof widget.sendTextMessage === 'function') {
                        widget.sendTextMessage(message);
                        console.log('✅ Sent message to ElevenLabs agent via API:', message);
                        return;
                    }

                    // Method 2: Try to access the widget's internal methods
                    if (widget.convai && widget.convai.sendMessage) {
                        widget.convai.sendMessage(message);
                        console.log('✅ Sent message to ElevenLabs agent via convai:', message);
                        return;
                    }

                    // Method 3: Try to find and interact with the input field
                    const findAndFillInput = () => {
                        // Look in shadow DOM first
                        let widgetInput = widget.shadowRoot?.querySelector('input[type="text"]') ||
                            widget.shadowRoot?.querySelector('textarea') ||
                            widget.shadowRoot?.querySelector('[contenteditable="true"]');

                        // Fallback to regular DOM
                        if (!widgetInput) {
                            widgetInput = widget.querySelector('input[type="text"]') ||
                                widget.querySelector('textarea') ||
                                widget.querySelector('[contenteditable="true"]');
                        }

                        if (widgetInput) {
                            // Clear existing content
                            widgetInput.value = '';
                            widgetInput.textContent = '';

                            // Set the message
                            widgetInput.value = message;
                            widgetInput.textContent = message;

                            // Trigger input events
                            widgetInput.dispatchEvent(new Event('input', { bubbles: true }));
                            widgetInput.dispatchEvent(new Event('change', { bubbles: true }));
                            widgetInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', bubbles: true }));

                            // Try to find and click send button
                            setTimeout(() => {
                                let sendBtn = widget.shadowRoot?.querySelector('button[type="submit"]') ||
                                    widget.shadowRoot?.querySelector('button:contains("Send")') ||
                                    widget.shadowRoot?.querySelector('.send-button') ||
                                    widget.shadowRoot?.querySelector('[aria-label*="send"]') ||
                                    widget.shadowRoot?.querySelector('[title*="send"]');

                                if (!sendBtn) {
                                    sendBtn = widget.querySelector('button[type="submit"]') ||
                                        widget.querySelector('.send-button') ||
                                        widget.querySelector('[aria-label*="send"]') ||
                                        widget.querySelector('[title*="send"]');
                                }

                                if (sendBtn) {
                                    sendBtn.click();
                                    console.log('✅ Sent message to ElevenLabs agent via input field:', message);
                                } else {
                                    // Try Enter key as last resort
                                    widgetInput.dispatchEvent(new KeyboardEvent('keypress', { key: 'Enter', bubbles: true }));
                                    console.log('✅ Attempted to send message via Enter key:', message);
                                }
                            }, 100);

                            return true;
                        }
                        return false;
                    };

                    // Try to find input immediately and with delays
                    if (!findAndFillInput()) {
                        setTimeout(findAndFillInput, 500);
                        setTimeout(findAndFillInput, 1000);
                    }

                }, 200);

            } catch (error) {
                console.log('❌ Error syncing message to voice widget:', error);
            }
        }

        // Track messages to prevent duplicates
        let processedMessages = new Set();
        let lastUserMessage = '';

        function monitorVoiceWidgetForMessages() {
            const widget = document.querySelector('elevenlabs-convai');
            if (!widget) {
                console.log('Widget not found, retrying...');
                setTimeout(monitorVoiceWidgetForMessages, 1000);
                return;
            }

            // Monitor for new messages from voice widget
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        // Check for new message elements
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                // Look for message content in various possible structures
                                const messageText = extractMessageFromNode(node);

                                if (messageText && messageText.trim().length > 15) { // Increased minimum length
                                    const messageId = generateMessageId(messageText);

                                    // Skip if we've already processed this message
                                    if (processedMessages.has(messageId)) {
                                        console.log('⏭️ Skipping duplicate message:', messageText.substring(0, 30) + '...');
                                        return;
                                    }

                                    // Skip if this is the user message we just sent (to prevent echo)
                                    if (messageText.trim() === lastUserMessage.trim()) {
                                        processedMessages.add(messageId);
                                        console.log('⏭️ Skipping user message echo:', messageText.substring(0, 30) + '...');
                                        return;
                                    }

                                    // Determine message type based on widget structure and content
                                    const messageType = determineMessageType(node, messageText);

                                    if (messageType === 'user') {
                                        // Add user message from voice widget
                                        processedMessages.add(messageId);
                                        addMessageToChat('user', messageText);
                                        addToTranscript(`User: ${messageText}`);
                                        console.log('✅ Added user voice message to main chat:', messageText.substring(0, 50) + '...');
                                    } else if (messageType === 'ai') {
                                        // Add AI response from voice widget
                                        processedMessages.add(messageId);
                                        addMessageToChat('ai', messageText);
                                        addToTranscript(`AI: ${messageText}`);
                                        console.log('✅ Added ElevenLabs AI response to main chat:', messageText.substring(0, 50) + '...');
                                    } else {
                                        // Skip unknown/duplicate messages
                                        processedMessages.add(messageId);
                                        console.log('⏭️ Skipping unknown message type:', messageText.substring(0, 30) + '...');
                                    }
                                }
                            }
                        });
                    }
                });
            });

            // Start observing the widget for changes
            observer.observe(widget, {
                childList: true,
                subtree: true,
                characterData: true
            });

            console.log('✅ Started monitoring ElevenLabs widget for messages');
            return observer;
        }

        function extractMessageFromNode(node) {
            // Try different ways to extract message text
            let messageText = '';

            // Method 1: Direct text content
            messageText = node.textContent || node.innerText || '';

            // Method 2: Look for specific message containers
            if (!messageText) {
                const messageContainers = node.querySelectorAll('[class*="message"], [class*="text"], [class*="content"]');
                for (const container of messageContainers) {
                    const text = container.textContent || container.innerText;
                    if (text && text.length > messageText.length) {
                        messageText = text;
                    }
                }
            }

            return messageText.trim();
        }

        function determineMessageType(node, messageText) {
            console.log('🔍 Analyzing message:', messageText.substring(0, 50) + '...');
            console.log('🔍 Node classes:', node.className);
            console.log('🔍 Node parent classes:', node.parentElement?.className);

            // Skip if this matches our last sent text message (to avoid duplicates)
            if (lastUserMessage && messageText.trim() === lastUserMessage.trim()) {
                console.log('⏭️ Skipping duplicate text message');
                return 'skip';
            }

            // Method 1: Check DOM structure - look for user/human indicators in the element or its parents
            const checkElement = (element) => {
                if (!element) return null;

                const classes = element.className || '';
                const id = element.id || '';
                const dataRole = element.getAttribute('data-role') || '';
                const ariaLabel = element.getAttribute('aria-label') || '';

                // Check for user indicators
                if (classes.includes('user') || classes.includes('human') || classes.includes('customer') ||
                    id.includes('user') || id.includes('human') || id.includes('customer') ||
                    dataRole.includes('user') || dataRole.includes('human') ||
                    ariaLabel.includes('user') || ariaLabel.includes('human')) {
                    return 'user';
                }

                // Check for AI/assistant indicators
                if (classes.includes('ai') || classes.includes('assistant') || classes.includes('bot') || classes.includes('agent') ||
                    id.includes('ai') || id.includes('assistant') || id.includes('bot') || id.includes('agent') ||
                    dataRole.includes('ai') || dataRole.includes('assistant') || dataRole.includes('bot') ||
                    ariaLabel.includes('ai') || ariaLabel.includes('assistant') || ariaLabel.includes('bot')) {
                    return 'ai';
                }

                return null;
            };

            // Check the node and its parents
            let currentElement = node;
            for (let i = 0; i < 5 && currentElement; i++) {
                const result = checkElement(currentElement);
                if (result) {
                    console.log('✅ Found', result, 'indicator in DOM structure');
                    return result;
                }
                currentElement = currentElement.parentElement;
            }

            // Method 2: Check position in widget (left side usually user, right side usually AI)
            const rect = node.getBoundingClientRect();
            const widget = document.querySelector('elevenlabs-convai');
            if (widget) {
                const widgetRect = widget.getBoundingClientRect();
                const relativePosition = rect.left - widgetRect.left;
                const widgetWidth = widgetRect.width;

                if (relativePosition < widgetWidth * 0.6) {
                    console.log('✅ Message on left side - assuming user');
                    return 'user';
                } else {
                    console.log('✅ Message on right side - assuming AI');
                    return 'ai';
                }
            }

            // Method 3: Simple content-based detection as fallback
            const text = messageText.toLowerCase();

            // Strong user indicators
            if (text.includes('hey') || text.includes('hello') || text.includes('hi') ||
                text.includes('i want') || text.includes('i need') || text.includes('can you') ||
                text.includes('please') || text.includes('help me')) {
                console.log('✅ User content pattern detected');
                return 'user';
            }

            // Strong AI indicators  
            if (text.includes('how can i assist') || text.includes('let me help') ||
                text.includes('i can help') || text.includes('verify') || text.includes('proceed')) {
                console.log('✅ AI content pattern detected');
                return 'ai';
            }

            // Default to user if we can't determine (better to show user messages than miss them)
            console.log('⚠️ Could not determine - defaulting to user');
            return 'user';
        }

        function generateMessageId(messageText) {
            // Create a simple hash of the message for duplicate detection
            return btoa(messageText.trim().substring(0, 100)).replace(/[^a-zA-Z0-9]/g, '');
        }

        function isLikelyUserMessage(messageText) {
            const text = messageText.toLowerCase().trim();

            // Common user message patterns
            const userPatterns = [
                /^i need/,
                /^i want/,
                /^i have/,
                /^can you/,
                /^please/,
                /^help me/,
                /^i'm/,
                /^my/,
                /^how do i/,
                /^what is/,
                /^where/,
                /^when/,
                /^why/,
                /^book.*appointment/,
                /^schedule/,
                /^i feel/,
                /^i am/
            ];

            // Check if message matches user patterns
            for (const pattern of userPatterns) {
                if (pattern.test(text)) {
                    return true;
                }
            }

            // Check if it's exactly the same as recent user input
            if (lastUserMessage && text === lastUserMessage.toLowerCase().trim()) {
                return true;
            }

            return false;
        }

        // Update the sync function to track user messages
        const originalSyncMessageToVoiceWidget = syncMessageToVoiceWidget;
        syncMessageToVoiceWidget = function (sender, message) {
            if (sender === 'user') {
                lastUserMessage = message.trim();
            }
            return originalSyncMessageToVoiceWidget(sender, message);
        };

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'flex items-start space-x-6 opacity-0 animate-fade-in-up mb-6';

            typingDiv.innerHTML = `
                <div class="flex-shrink-0 w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center shadow-xl">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <div class="flex-1 bg-white/15 backdrop-blur-sm rounded-3xl p-8 border border-white/30 shadow-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-purple-300 text-lg font-bold">🤖 AI Assistant</span>
                        <span class="text-white/60 text-sm">typing...</span>
                    </div>
                    <div class="flex space-x-2">
                        <div class="w-4 h-4 bg-purple-400 rounded-full animate-bounce"></div>
                        <div class="w-4 h-4 bg-pink-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-4 h-4 bg-yellow-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
            `;

            chatMessages.appendChild(typingDiv);
            setTimeout(() => {
                typingDiv.classList.remove('opacity-0');
                scrollToBottom();
            }, 100);
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // --- SMART AI Response Generation ---
        function generateAIResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();

            // Emergency symptoms - immediate attention needed
            const emergencyKeywords = ['chest pain', 'heart attack', 'stroke', 'difficulty breathing', 'severe bleeding', 'unconscious', 'suicide', 'overdose'];
            for (const keyword of emergencyKeywords) {
                if (lowerMessage.includes(keyword)) {
                    return "🚨 **EMERGENCY ALERT** 🚨\n\nThis sounds like a medical emergency. Please:\n• Call 911 immediately\n• Go to the nearest emergency room\n• Don't delay seeking immediate medical attention\n\nIf you're having chest pain, difficulty breathing, or signs of stroke, every minute counts. Please get emergency help right away.";
                }
            }

            // Comprehensive symptom responses
            const symptomResponses = {
                'fever': {
                    keywords: ['fever', 'temperature', 'hot', 'chills', 'burning up'],
                    response: "🌡️ **Fever Management**\n\n**Immediate Steps:**\n• Monitor temperature every 2-4 hours\n• Stay hydrated (water, clear broths, electrolyte drinks)\n• Rest in a cool, comfortable environment\n• Take acetaminophen or ibuprofen as directed\n\n**When to Seek Care:**\n• Fever above 103°F (39.4°C)\n• Fever lasting more than 3 days\n• Severe symptoms like difficulty breathing\n• Signs of dehydration\n\n**Would you like me to help you book an appointment or provide more specific guidance?**"
                },
                'headache': {
                    keywords: ['headache', 'migraine', 'head pain', 'head hurts'],
                    response: "🧠 **Headache Relief**\n\n**Immediate Relief:**\n• Rest in a quiet, dark room\n• Apply cold or warm compress to head/neck\n• Stay hydrated\n• Gentle neck/shoulder massage\n• Over-the-counter pain relievers (follow package directions)\n\n**Red Flags - Seek immediate care if:**\n• Sudden, severe headache unlike any before\n• Headache with fever, stiff neck, confusion\n• Headache after head injury\n• Vision changes or weakness\n\n**Would you like tips for preventing future headaches?**"
                },
                'stomach': {
                    keywords: ['stomach', 'nausea', 'vomiting', 'diarrhea', 'abdominal', 'belly'],
                    response: "🤢 **Stomach Issues**\n\n**For Nausea/Vomiting:**\n• Sip clear fluids slowly (water, ginger tea, clear broth)\n• Try the BRAT diet (Bananas, Rice, Applesauce, Toast)\n• Avoid dairy, fatty, or spicy foods\n• Rest and avoid strong odors\n\n**For Diarrhea:**\n• Stay hydrated with electrolyte solutions\n• Eat bland, binding foods\n• Avoid dairy and high-fiber foods temporarily\n\n**Seek care if:**\n• Severe dehydration\n• Blood in vomit/stool\n• Severe abdominal pain\n• Symptoms persist >48 hours"
                },
                'cough': {
                    keywords: ['cough', 'coughing', 'throat', 'sore throat'],
                    response: "😷 **Cough & Throat Care**\n\n**Soothing Remedies:**\n• Warm salt water gargle\n• Honey and warm water\n• Stay hydrated\n• Use a humidifier\n• Throat lozenges\n• Avoid irritants (smoke, strong scents)\n\n**Types of Coughs:**\n• Dry cough: Often viral, focus on soothing\n• Productive cough: Help loosen mucus with hydration\n\n**See a doctor if:**\n• Cough with blood\n• High fever\n• Difficulty breathing\n• Cough lasting >3 weeks"
                },
                'appointment': {
                    keywords: ['appointment', 'schedule', 'book', 'visit', 'see doctor'],
                    response: "📅 **Appointment Scheduling**\n\n**Available Services:**\n• General consultations\n• Specialist referrals\n• Preventive care & checkups\n• Urgent care visits\n• Follow-up appointments\n\n**Appointment Options:**\n• Same-day urgent appointments\n• Regular scheduled visits\n• Telemedicine consultations\n• Specialist referrals\n\n**To book your appointment:**\n1. Call our clinic at [Phone Number]\n2. Use our online booking system\n3. Walk-in for urgent care (limited availability)\n\n**What type of appointment would you prefer, and do you have any specific health concerns to discuss?**"
                },
                'medication': {
                    keywords: ['medication', 'medicine', 'pills', 'prescription', 'drug'],
                    response: "💊 **Medication Information**\n\n**Important Note:** Specific prescriptions must be discussed with a healthcare provider.\n\n**Common Over-the-Counter Options:**\n• Pain/Fever: Acetaminophen, Ibuprofen\n• Allergies: Antihistamines (Benadryl, Claritin)\n• Stomach: Antacids, Anti-diarrheal\n• Cough/Cold: Cough suppressants, decongestants\n\n**Medication Safety:**\n• Always read labels and follow directions\n• Check for drug interactions\n• Don't exceed recommended doses\n• Store medications properly\n\n**Questions to ask your doctor:**\n• What are the side effects?\n• How long should I take this?\n• Any food or drug interactions?\n\n**Would you like to schedule a consultation to discuss your medication needs?**"
                }
            };

            // Check for symptom matches
            for (const [category, data] of Object.entries(symptomResponses)) {
                for (const keyword of data.keywords) {
                    if (lowerMessage.includes(keyword)) {
                        return data.response;
                    }
                }
            }

            // Greeting responses
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey')) {
                return "👋 **Hello! Welcome to AI Health Clinic Bhopal**\n\nI'm your AI Health Assistant, here to help you with:\n• Symptom guidance and care advice\n• Appointment scheduling\n• General health information\n• When to seek medical attention\n\n**How can I assist you with your health today?** You can describe your symptoms, ask health questions, or request an appointment.";
            }

            // Thank you responses
            if (lowerMessage.includes('thank') || lowerMessage.includes('thanks')) {
                return "😊 **You're very welcome!**\n\nI'm glad I could help. Remember:\n• Your health is important - don't hesitate to seek professional care when needed\n• I'm here 24/7 for health guidance and support\n• For emergencies, always call 911 or go to the nearest ER\n\n**Is there anything else I can help you with today?**";
            }

            // Default intelligent response
            return "🤖 **I'm here to help with your health concerns!**\n\n**I can assist you with:**\n• Symptom analysis and care recommendations\n• When to seek medical attention\n• Appointment scheduling\n• General health information\n• Medication guidance\n\n**To give you the best help, could you please:**\n• Describe your specific symptoms\n• Let me know how long you've been experiencing them\n• Mention any other relevant health information\n\n**What specific health concern would you like guidance on today?**";
        }

        // --- Transcript Management ---
        function addToTranscript(text) {
            const transcriptContent = document.getElementById('transcript-content');
            const transcriptContainer = document.getElementById('transcript-container');

            if (transcriptContent && transcriptContainer) {
                const timestamp = new Date().toLocaleString();
                const entry = document.createElement('div');
                entry.className = 'mb-4 p-3 bg-gray-50 rounded-lg border-l-4 border-teal-500';
                entry.innerHTML = `
                    <div class="text-xs text-gray-500 mb-2">${timestamp}</div>
                    <div class="text-gray-800 whitespace-pre-line">${text}</div>
                `;

                transcriptContent.appendChild(entry);
                transcriptContainer.classList.remove('hidden');

                // Scroll to bottom
                transcriptContent.scrollTop = transcriptContent.scrollHeight;
            }
        }

        // --- Enhanced Analysis Workflow ---
        async function handleAnalyzeClick() {
            try {
                // Disable button and show loading state
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = `
                    <svg class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Processing...
                `;

                // Step 1: Fetch and Display Transcript
                updateStatus("🔍 Fetching conversation transcript...", "loading");
                const transcript = await getConversationHistory();

                if (!transcript || transcript.trim() === '') {
                    throw new Error('No conversation found. Please have a conversation with the AI assistant first.');
                }

                displayTranscript(transcript);
                await new Promise(resolve => setTimeout(resolve, 800)); // Allow user to see transcript

                // Step 2: Analyze conversation locally
                updateStatus("🧠 Analyzing conversation with AI...", "loading");
                const analysisResult = await analyzeConversationLocally(transcript);

                // Validate analysis result
                if (!analysisResult || !analysisResult.disease) {
                    throw new Error('Analysis failed to extract meaningful information from the conversation.');
                }

                // Step 3: Save to local storage
                updateStatus("💾 Saving analysis to your dashboard...", "loading");
                const savedConversation = await saveToLocalStorage(analysisResult, transcript);

                // Step 4: Show success with detailed results
                const resultSummary = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-4">
                        <h4 class="font-semibold text-green-800 mb-2">Analysis Complete!</h4>
                        <div class="text-sm text-green-700 space-y-1">
                            <p><strong>Condition:</strong> ${analysisResult.disease}</p>
                            <p><strong>Appointment:</strong> ${analysisResult.appointmentStatus}</p>
                            <p><strong>Time:</strong> ${analysisResult.appointmentTime}</p>
                        </div>
                        <div class="mt-3 flex space-x-2">
                            <a href="./dashboard.html" class="inline-flex items-center px-3 py-1 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 transition-colors">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                View Dashboard
                            </a>
                            <button onclick="startNewConversation()" class="inline-flex items-center px-3 py-1 bg-teal-600 text-white text-sm rounded-md hover:bg-teal-700 transition-colors">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                New Conversation
                            </button>
                        </div>
                    </div>
                `;

                updateStatus("✅ Analysis saved successfully!", "success");
                statusText.innerHTML += resultSummary;

                // Auto-clear success message after 10 seconds
                setTimeout(() => {
                    updateStatus("", "");
                }, 10000);

            } catch (error) {
                console.error("Error during analysis process:", error);

                // Show detailed error message
                const errorMessage = error.message || 'An unexpected error occurred during analysis.';
                updateStatus(`❌ ${errorMessage}`, "error");

                // Add retry button for certain errors
                if (error.message.includes('conversation') || error.message.includes('transcript')) {
                    statusText.innerHTML += `
                        <div class="mt-2">
                            <button onclick="handleAnalyzeClick()" class="text-sm text-teal-600 hover:text-teal-700 underline">
                                Try Again
                            </button>
                        </div>
                    `;
                }

                // Auto-clear error message after 8 seconds
                setTimeout(() => {
                    updateStatus("", "");
                }, 8000);

            } finally {
                // Reset button state
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    Analyze Conversation & Save to Dashboard
                `;
            }
        }

        // Helper function for starting new conversation
        function startNewConversation() {
            // Clear transcript
            transcriptContent.innerHTML = '';
            transcriptContainer.classList.add('hidden');

            // Clear status
            updateStatus("", "");

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Focus on chat widget area
            chatWidgetContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-xl shadow-2xl transition-all duration-300 transform translate-x-full`;

            // Set colors based on type
            const colors = {
                'success': 'bg-green-500 text-white border-green-400',
                'error': 'bg-red-500 text-white border-red-400',
                'warning': 'bg-yellow-500 text-white border-yellow-400',
                'info': 'bg-blue-500 text-white border-blue-400',
                'loading': 'bg-purple-500 text-white border-purple-400'
            };

            notification.className += ` ${colors[type] || colors.info} border-2 backdrop-blur-sm`;

            // Add loading spinner for loading type
            const spinner = type === 'loading' ?
                '<div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin mr-3"></div>' : '';

            notification.innerHTML = `
                <div class="flex items-center">
                    ${spinner}
                    <span class="font-medium">${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);

            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        function updateStatus(message, type) {
            statusText.innerHTML = '';
            if (message) {
                const icon = type === 'loading' ?
                    '<svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>' :
                    type === 'success' ? '<svg class="w-4 h-4 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' :
                        type === 'error' ? '<svg class="w-4 h-4 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' : '';

                statusText.innerHTML = `<span class="inline-flex items-center">${icon}${message}</span>`;
            }
        }

        // --- Helper Functions ---
        async function getConversationHistory() {
            // For demo purposes, we'll simulate getting conversation data
            // In a real implementation, this would fetch from ElevenLabs API
            console.log("Simulating conversation fetch...");

            // Array of sample conversations for testing different scenarios
            const sampleConversations = [
                // Flu with booked appointment
                `Patient: Hello, I've been feeling quite unwell lately. I have a sore throat, a cough, and a running nose.
AI: I'm sorry to hear that you're not feeling well. Can you tell me more about your symptoms? Have you experienced a fever?
Patient: Yes, I have a mild fever, around 100 degrees Fahrenheit. I think it might be the flu. I'd like to book an appointment to be sure.
AI: I understand your concern. Based on your symptoms - sore throat, cough, runny nose, and mild fever - it could indeed be a viral infection. I have an opening tomorrow, September 3rd, at 10:30 AM. Does that work for you?
Patient: Yes, that's perfect. Please book it for me.
AI: Excellent! I have confirmed your appointment for September 3rd at 10:30 AM. We look forward to seeing you. Please bring a list of any medications you're currently taking.`,

                // Headache with pending appointment
                `Patient: Hi, I've been having severe headaches for the past few days.
AI: I'm sorry to hear about your headaches. Can you describe the pain? Is it constant or does it come and go?
Patient: It's mostly constant, and it gets worse in the afternoon. I also feel a bit nauseous sometimes.
AI: That sounds concerning. These could be tension headaches or possibly migraines. Would you like to schedule an appointment for a proper evaluation?
Patient: Yes, I think that would be a good idea. When do you have availability?
AI: I can check our schedule and get back to you with available times. We'll make sure to fit you in as soon as possible.`,

                // Back pain with booked appointment
                `Patient: I've been experiencing lower back pain for about a week now.
AI: I understand that must be uncomfortable. Can you tell me what might have triggered the pain? Any recent activities or movements?
Patient: I think it started after I helped my friend move furniture last weekend. The pain is worse when I sit for long periods.
AI: That sounds like it could be a muscle strain from lifting. Have you tried any pain relief methods?
Patient: I've been taking ibuprofen, but it only helps temporarily. I'd like to see a doctor about this.
AI: That's a wise decision. I have an appointment available this Friday, September 6th, at 2:00 PM. Would that work for you?
Patient: Yes, that sounds perfect. Please book it.
AI: Done! Your appointment is confirmed for Friday, September 6th, at 2:00 PM. Please avoid heavy lifting until then.`,

                // General checkup
                `Patient: Hi, I'd like to schedule a routine checkup. It's been about a year since my last visit.
AI: That's great that you're staying on top of your health! A yearly checkup is important for preventive care.
Patient: Yes, I want to make sure everything is okay. I've been feeling fine, but I'd like to get my blood pressure and cholesterol checked.
AI: Absolutely. We can do a comprehensive physical exam including blood work. I have availability next Tuesday, September 10th, at 9:00 AM.
Patient: That works perfectly for me.
AI: Wonderful! I've scheduled your routine physical exam for Tuesday, September 10th, at 9:00 AM. Please fast for 12 hours before the appointment for accurate blood work results.`,

                // Anxiety consultation
                `Patient: I've been feeling really anxious lately, and it's affecting my daily life.
AI: I'm sorry to hear you're experiencing anxiety. That can be very challenging. Can you tell me more about when these feelings occur?
Patient: It happens mostly at work and sometimes at night when I'm trying to sleep. My heart races and I feel overwhelmed.
AI: Those are common symptoms of anxiety. It's important to address this with proper support. Would you like to speak with one of our mental health specialists?
Patient: Yes, I think that would really help me.
AI: I can arrange a consultation with Dr. Smith, our anxiety specialist. She has an opening this Thursday at 3:30 PM.
Patient: That would be great, thank you.
AI: Perfect! Your appointment with Dr. Smith is confirmed for Thursday at 3:30 PM. She specializes in anxiety management and will be able to help you develop coping strategies.`
            ];

            // Randomly select one of the sample conversations for variety
            const randomIndex = Math.floor(Math.random() * sampleConversations.length);
            return sampleConversations[randomIndex];
        }

        function displayTranscript(transcript) {
            transcriptContent.innerHTML = '';

            if (!transcript || transcript.trim() === '') {
                transcriptContent.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="w-12 h-12 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <p class="text-gray-500">No conversation found.</p>
                        <p class="text-sm text-gray-400 mt-1">Please have a conversation with the AI assistant first.</p>
                    </div>
                `;
                transcriptContainer.classList.remove('hidden');
                return;
            }

            // Add timestamp
            const timestampDiv = document.createElement('div');
            timestampDiv.className = 'text-xs text-gray-500 text-center mb-4 pb-2 border-b border-gray-200';
            timestampDiv.innerHTML = `<span class="bg-gray-100 px-2 py-1 rounded-full">Conversation from ${new Date().toLocaleString()}</span>`;
            transcriptContent.appendChild(timestampDiv);

            transcript.split('\n').forEach((line, index) => {
                if (line.trim()) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'mb-6 animate-fade-in message-bubble';
                    messageDiv.style.animationDelay = `${index * 0.15}s`;

                    if (line.startsWith('Patient:')) {
                        messageDiv.innerHTML = `
                            <div class="flex items-start space-x-4">
                                <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center shadow-lg ring-2 ring-blue-100">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                <div class="flex-1 conversation-flow border-l-4 border-blue-400 bg-gradient-to-r from-blue-50 to-white shadow-sm">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center">
                                            <span class="font-semibold text-blue-800 text-sm">Patient</span>
                                            <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">You</span>
                                        </div>
                                        <span class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">${new Date().toLocaleTimeString()}</span>
                                    </div>
                                    <p class="text-gray-800 leading-relaxed text-sm font-medium">${line.substring(8).trim()}</p>
                                </div>
                            </div>
                        `;
                    } else if (line.startsWith('AI:')) {
                        messageDiv.innerHTML = `
                            <div class="flex items-start space-x-4">
                                <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-teal-500 to-teal-600 rounded-full flex items-center justify-center shadow-lg ring-2 ring-teal-100">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                </div>
                                <div class="flex-1 conversation-flow border-l-4 border-teal-400 bg-gradient-to-r from-teal-50 to-white shadow-sm">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center">
                                            <span class="font-semibold text-teal-800 text-sm">AI Health Assistant</span>
                                            <span class="ml-2 px-2 py-1 bg-teal-100 text-teal-700 text-xs rounded-full">AI</span>
                                        </div>
                                        <span class="text-xs text-teal-600 bg-teal-50 px-2 py-1 rounded">${new Date().toLocaleTimeString()}</span>
                                    </div>
                                    <p class="text-gray-800 leading-relaxed text-sm">${line.substring(3).trim()}</p>
                                </div>
                            </div>
                        `;
                    }

                    transcriptContent.appendChild(messageDiv);
                }
            });

            // Show container with smooth animation
            transcriptContainer.classList.remove('hidden');

            // Smooth scroll to bottom
            setTimeout(() => {
                transcriptContent.scrollTo({
                    top: transcriptContent.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        // Add CSS animations and enhanced styling
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fade-in {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in {
                animation: fade-in 0.3s ease-out forwards;
                opacity: 0;
            }
            
            @keyframes typing {
                0%, 50% { opacity: 1; }
                51%, 100% { opacity: 0; }
            }
            .typing-indicator {
                animation: typing 1.5s infinite;
            }
            
            /* Enhanced message bubbles */
            .message-bubble {
                position: relative;
                transition: all 0.2s ease;
            }
            .message-bubble:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            
            /* Conversation flow styling */
            .conversation-flow {
                background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
                border-radius: 16px;
                padding: 1rem;
                margin: 0.5rem 0;
            }
        `;
        document.head.appendChild(style);

        // Enhanced conversation monitoring (for future ElevenLabs integration)
        function startConversationMonitoring() {
            // This could be enhanced to listen to actual ElevenLabs events
            // For now, it provides a framework for real-time conversation capture
            console.log('Conversation monitoring started - ready to capture real-time dialogue');

            // Example: Listen for ElevenLabs widget events
            const widget = document.querySelector('elevenlabs-convai');
            if (widget) {
                // Add event listeners for conversation events
                widget.addEventListener('conversationStart', () => {
                    console.log('Conversation started');
                    showConversationStatus('Conversation started...', 'active');
                });

                widget.addEventListener('conversationEnd', () => {
                    console.log('Conversation ended');
                    showConversationStatus('Conversation ended', 'completed');
                });
            }
        }

        function showConversationStatus(message, type) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `fixed top-20 right-4 z-40 px-4 py-2 rounded-lg shadow-lg transition-all duration-300 ${type === 'active' ? 'bg-blue-500 text-white' :
                type === 'completed' ? 'bg-green-500 text-white' :
                    'bg-gray-500 text-white'
                }`;
            statusDiv.textContent = message;

            document.body.appendChild(statusDiv);

            setTimeout(() => {
                statusDiv.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(statusDiv);
                }, 300);
            }, 3000);
        }

        // Initialize conversation monitoring when widget is ready
        setTimeout(() => {
            startConversationMonitoring();
        }, 3000);

        // Update current time
        function updateTime() {
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', {
                    hour12: true,
                    hour: '2-digit',
                    minute: '2-digit'
                });
                timeElement.textContent = timeString;
            }
        }

        // Update time every second
        setInterval(updateTime, 1000);
        updateTime(); // Initial call

        // --- Local Conversation Analysis Engine ---
        async function analyzeConversationLocally(transcript) {
            if (!transcript || transcript.trim() === '') {
                throw new Error('No conversation transcript to analyze');
            }

            const analysis = {
                disease: extractMedicalConditions(transcript),
                appointmentStatus: detectAppointmentBooking(transcript),
                appointmentTime: extractAppointmentDetails(transcript)
            };

            // Simulate processing time for better UX
            await new Promise(resolve => setTimeout(resolve, 1500));

            return analysis;
        }

        function extractMedicalConditions(transcript) {
            const text = transcript.toLowerCase();

            // Define medical condition patterns and keywords
            const conditionPatterns = {
                'Flu/Cold': ['flu', 'cold', 'sore throat', 'cough', 'runny nose', 'running nose', 'congestion', 'sneezing', 'fever'],
                'Headache/Migraine': ['headache', 'migraine', 'head pain', 'head ache'],
                'Stomach Issues': ['stomach ache', 'nausea', 'vomiting', 'diarrhea', 'stomach pain', 'abdominal pain'],
                'Respiratory Issues': ['breathing problems', 'shortness of breath', 'chest pain', 'wheezing', 'asthma'],
                'Skin Issues': ['rash', 'itching', 'skin irritation', 'allergic reaction', 'hives'],
                'Back/Joint Pain': ['back pain', 'joint pain', 'muscle pain', 'arthritis', 'stiffness'],
                'Anxiety/Stress': ['anxiety', 'stress', 'panic', 'worried', 'nervous', 'depression'],
                'Injury': ['injury', 'hurt', 'pain', 'sprain', 'bruise', 'cut', 'wound'],
                'General Checkup': ['checkup', 'check up', 'routine', 'physical exam', 'wellness visit']
            };

            const foundConditions = [];
            const symptomCounts = {};

            // Count symptoms for each condition
            for (const [condition, symptoms] of Object.entries(conditionPatterns)) {
                let count = 0;
                symptoms.forEach(symptom => {
                    if (text.includes(symptom)) {
                        count++;
                    }
                });
                if (count > 0) {
                    symptomCounts[condition] = count;
                    foundConditions.push({ condition, count });
                }
            }

            // Sort by symptom count and return the most likely condition
            foundConditions.sort((a, b) => b.count - a.count);

            if (foundConditions.length > 0) {
                const primaryCondition = foundConditions[0].condition;

                // Add additional context if multiple symptoms
                if (foundConditions.length > 1) {
                    const secondaryConditions = foundConditions.slice(1, 3).map(c => c.condition);
                    return `${primaryCondition} (also: ${secondaryConditions.join(', ')})`;
                }

                return primaryCondition;
            }

            // Fallback: look for general health mentions
            if (text.includes('not feeling well') || text.includes('unwell') || text.includes('sick')) {
                return 'General illness/discomfort';
            }

            return 'General consultation';
        }

        function detectAppointmentBooking(transcript) {
            const text = transcript.toLowerCase();

            // Patterns indicating successful booking
            const bookedPatterns = [
                'confirmed',
                'booked',
                'scheduled',
                'appointment is set',
                'see you',
                'look forward to seeing you',
                'your appointment',
                'i have confirmed'
            ];

            // Patterns indicating appointment request/pending
            const pendingPatterns = [
                'would like to book',
                'want to schedule',
                'need an appointment',
                'can i book',
                'available',
                'when can i come',
                'do you have'
            ];

            // Check for confirmed booking first
            for (const pattern of bookedPatterns) {
                if (text.includes(pattern)) {
                    return 'Booked';
                }
            }

            // Check for appointment requests
            for (const pattern of pendingPatterns) {
                if (text.includes(pattern)) {
                    return 'Pending';
                }
            }

            // Check if appointment was mentioned at all
            if (text.includes('appointment')) {
                return 'Pending';
            }

            return 'N/A';
        }

        function extractAppointmentDetails(transcript) {
            const text = transcript.toLowerCase();

            // If no appointment was booked, return N/A
            if (detectAppointmentBooking(transcript) === 'N/A') {
                return 'N/A';
            }

            // Date patterns
            const datePatterns = [
                /tomorrow/i,
                /today/i,
                /next week/i,
                /monday|tuesday|wednesday|thursday|friday|saturday|sunday/i,
                /january|february|march|april|may|june|july|august|september|october|november|december/i,
                /\d{1,2}(st|nd|rd|th)/i,
                /\d{1,2}\/\d{1,2}/i,
                /\d{1,2}-\d{1,2}/i
            ];

            // Time patterns
            const timePatterns = [
                /\d{1,2}:\d{2}\s*(am|pm)/i,
                /\d{1,2}\s*(am|pm)/i,
                /morning/i,
                /afternoon/i,
                /evening/i
            ];

            let dateFound = '';
            let timeFound = '';

            // Extract date information
            for (const pattern of datePatterns) {
                const match = transcript.match(pattern);
                if (match) {
                    dateFound = match[0];
                    break;
                }
            }

            // Extract time information
            for (const pattern of timePatterns) {
                const match = transcript.match(pattern);
                if (match) {
                    timeFound = match[0];
                    break;
                }
            }

            // Combine date and time
            if (dateFound && timeFound) {
                return `${dateFound} at ${timeFound}`;
            } else if (dateFound) {
                return dateFound;
            } else if (timeFound) {
                return `Appointment at ${timeFound}`;
            }

            // Look for specific date/time mentions in the transcript
            const lines = transcript.split('\n');
            for (const line of lines) {
                if (line.toLowerCase().includes('appointment') || line.toLowerCase().includes('confirmed')) {
                    // Try to extract any date/time information from this line
                    const dateTimeMatch = line.match(/\b\w+\s+\d{1,2}(st|nd|rd|th)?,?\s+at\s+\d{1,2}:\d{2}\s*(am|pm)\b/i);
                    if (dateTimeMatch) {
                        return dateTimeMatch[0];
                    }
                }
            }

            return 'Appointment scheduled (time TBD)';
        }

        // --- Data Persistence and Management ---
        async function saveToLocalStorage(analysisResult, transcript) {
            try {
                const conversationSummary = {
                    id: generateUniqueId(),
                    timestamp: new Date().toISOString(),
                    disease: analysisResult.disease,
                    appointmentStatus: analysisResult.appointmentStatus,
                    appointmentTime: analysisResult.appointmentTime,
                    transcript: transcript
                };

                // Get existing conversations
                const existingConversations = getConversationSummaries();

                // Add new conversation
                existingConversations.push(conversationSummary);

                // Keep only the last 50 conversations to prevent storage overflow
                const limitedConversations = existingConversations.slice(-50);

                // Save to localStorage
                localStorage.setItem('healthClinicConversations', JSON.stringify(limitedConversations));

                // Trigger storage event for dashboard updates
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'healthClinicConversations',
                    newValue: JSON.stringify(limitedConversations),
                    storageArea: localStorage
                }));

                console.log("Conversation saved successfully:", conversationSummary);
                return conversationSummary;

            } catch (error) {
                console.error("Error saving to localStorage:", error);
                throw new Error("Failed to save conversation data");
            }
        }

        function getConversationSummaries() {
            try {
                const stored = localStorage.getItem('healthClinicConversations');
                return stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.error("Error reading from localStorage:", error);
                return [];
            }
        }

        function generateUniqueId() {
            return 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Data model validation
        function validateConversationSummary(summary) {
            const required = ['id', 'timestamp', 'disease', 'appointmentStatus', 'appointmentTime'];
            return required.every(field => summary.hasOwnProperty(field));
        }

        // Storage management utilities
        function clearAllConversations() {
            try {
                localStorage.removeItem('healthClinicConversations');
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'healthClinicConversations',
                    newValue: null,
                    storageArea: localStorage
                }));
                return true;
            } catch (error) {
                console.error("Error clearing conversations:", error);
                return false;
            }
        }

        function getStorageUsage() {
            try {
                const conversations = getConversationSummaries();
                const dataSize = JSON.stringify(conversations).length;
                return {
                    count: conversations.length,
                    sizeBytes: dataSize,
                    sizeKB: Math.round(dataSize / 1024 * 100) / 100
                };
            } catch (error) {
                return { count: 0, sizeBytes: 0, sizeKB: 0 };
            }
        }

        // Export conversation data (for backup/download)
        function exportConversations() {
            try {
                const conversations = getConversationSummaries();
                const dataStr = JSON.stringify(conversations, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `health_clinic_conversations_${new Date().toISOString().split('T')[0]}.json`;
                link.click();

                return true;
            } catch (error) {
                console.error("Error exporting conversations:", error);
                return false;
            }
        }
    </script>
</body>

</html>