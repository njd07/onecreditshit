<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Health Clinic Bhopal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #0f766e 0%, #0d9488 100%);
        }

        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-50 to-gray-100 text-gray-800 min-h-screen">
    <div class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="glass-effect border-b border-white/20 sticky top-0 z-50">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 gradient-bg rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z">
                                </path>
                            </svg>
                        </div>
                        <h1 class="text-2xl font-bold text-teal-700">AI Health Clinic Bhopal</h1>
                    </div>
                    <nav>
                        <a href="./dashboard.html"
                            class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white/80 hover:bg-white rounded-lg border border-gray-200 hover:border-teal-300 transition-all duration-200 shadow-sm hover:shadow-md">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                </path>
                            </svg>
                            View Dashboard
                        </a>
                    </nav>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="max-w-4xl mx-auto flex flex-col lg:flex-row lg:space-x-8">
                <!-- Left Content Column -->
                <div class="w-full lg:w-1/2">
                    <!-- Hero Section -->
                    <div class="text-left mb-12">
                        <div
                            class="inline-flex items-center px-4 py-2 bg-teal-50 text-teal-700 rounded-full text-sm font-medium mb-6">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            AI-Powered Healthcare Assistant
                        </div>
                        <h2 class="text-4xl md:text-6xl font-extrabold text-gray-900 mb-6 leading-tight">
                            Simple AI Voice-Bot
                            <span class="gradient-bg bg-clip-text text-transparent"> as a Health Assistant</span>
                        </h2>
                        <p class="text-xl text-gray-600 max-w-3xl mb-8 leading-relaxed">
                            But with access to:
                            <br>1. <u>MCP Support</u>: Zapier MCP
                            <br>2. <u>User Authentication</u> <30s using Email OTP
                            <br>3. Patient <u>History Retrieval</u>
                            <br><br><b>Front-end (HTML, JS, TSX)</b>: Nrishan, Ichhit
                            <br><b>System-Prompts & Workflow</b>: Vaani
                            <br><b>Backend (JS, PY)</b>: Omkar, Ujjawal
                            <br><br><i>Known Issue: 1/ Cannot Escalate to Phone Number & 2/ Delay of ~1sec while tool Calling</i>
                        </p>
                    </div>

                    <!-- Conversation Transcript Display -->
                    <div id="transcript-container"
                        class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden mb-8 hidden">
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-teal-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    Conversation Transcript (Sample)
                                </h3>
                            </div>
                        </div>
                        <div id="transcript-content"
                            class="max-h-80 overflow-y-auto p-6 bg-gradient-to-b from-white to-gray-50">
                        </div>
                    </div>

                    <!-- Analysis Section -->
                    <div class="text-left">
                        <button id="analyze-btn"
                            class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-teal-600 to-teal-700 text-white font-semibold rounded-xl shadow-lg hover:from-teal-700 hover:to-teal-800 transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z">
                                </path>
                            </svg>
                            Analyze Conversation & Save to Dashboard
                        </button>
                        <p id="status-text" class="text-gray-600 mt-4 min-h-[1.5rem] flex items-center">
                        </p>
                    </div>
                </div>

                <!-- Right Widget Column -->
                <div class="w-full lg:w-1/2 mt-8 lg:mt-0">
                    <div class="w-full mb-12">
                        <div class="bg-white rounded-3xl shadow-2xl border border-gray-200 overflow-hidden">
                            <div class="bg-gradient-to-r from-teal-500 via-teal-600 to-cyan-600 px-8 py-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-2xl font-bold text-white flex items-center">
                                            <svg class="w-7 h-7 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                            </svg>
                                            AI Health Consultation
                                        </h3>
                                        <p class="text-teal-100 text-lg mt-2">Start speaking with our AI health assistant</p>
                                    </div>
                                </div>
                            </div>
                            <div id="chat-widget-container" class="relative bg-white p-4 sm:p-8 lg:p-12 flex items-center justify-center"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="bg-white border-t border-gray-200 py-6">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center text-gray-600">
                    <p>&copy; 2025 AI Health Clinic Bhopal. Your health, our priority.</p>
                </div>
            </div>
        </footer>
    </div>

    <elevenlabs-convai id="elevenlabs-widget"></elevenlabs-convai>
    <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>

    <script src="config.js"></script>
    
    <script>
        const elevenLabsApiKey = window.AppConfig.apiKey;
        const agentId = window.AppConfig.agentId;

        const analyzeBtn = document.getElementById('analyze-btn');
        const statusText = document.getElementById('status-text');
        const transcriptContainer = document.getElementById('transcript-container');
        const transcriptContent = document.getElementById('transcript-content');
        const chatWidgetContainer = document.getElementById('chat-widget-container');

        // --- State Management ---
        let conversationHappened = false;

        // --- ElevenLabs Widget Management ---
        document.addEventListener('DOMContentLoaded', () => {
            const widget = document.getElementById('elevenlabs-widget');
            if (widget) {
                widget.setAttribute('agent-id', agentId);
            }
            initializeEventListeners();
            setTimeout(() => moveWidgetToContainer(), 2000);
        });

        function moveWidgetToContainer() {
            const widget = document.querySelector('elevenlabs-convai');
            const container = document.getElementById('chat-widget-container');
            if (widget && container) {
                container.innerHTML = '';
                container.appendChild(widget);
                console.log('ElevenLabs widget moved to container');
                startConversationMonitoring(); // Activate listener
            }
        }

        function initializeEventListeners() {
            analyzeBtn.addEventListener('click', handleAnalyzeClick);
        }

        // --- NEW, RELIABLE CONVERSATION DETECTION ---
        function startConversationMonitoring() {
            console.log('Attempting to monitor conversation...');
            const widget = document.querySelector('elevenlabs-convai');
            if (widget) {
                console.log('Widget found. Adding a click listener to detect conversation start.');
                // This is a robust way to detect interaction.
                // We listen for the first click on the widget to assume a conversation has started.
                widget.addEventListener('click', () => {
                    if (!conversationHappened) {
                        conversationHappened = true;
                        console.log("Conversation has started (detected by first click). Flag set to true.");
                        showConversationStatus('Conversation started...', 'active');
                    }
                }, { once: true }); // { once: true } ensures this only runs on the very first click.
            } else {
                console.warn('ElevenLabs widget not found for monitoring. Retrying...');
                setTimeout(startConversationMonitoring, 500); // Retry if not found
            }
        }

        async function handleAnalyzeClick() {
            try {
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = `<svg class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Processing...`;

                updateStatus("üîç Fetching conversation transcript...", "loading");
                const transcript = await getConversationHistory();

                if (!transcript) {
                    throw new Error('No conversation found. Please have a conversation with the AI assistant first.');
                }

                displayTranscript(transcript);
                await new Promise(resolve => setTimeout(resolve, 800));

                updateStatus("üß† Analyzing conversation with AI...", "loading");
                const analysisResult = await analyzeConversationLocally(transcript);

                if (!analysisResult || !analysisResult.disease) {
                    throw new Error('Analysis failed to extract meaningful information.');
                }

                updateStatus("üíæ Saving analysis to your dashboard...", "loading");
                await saveToLocalStorage(analysisResult, transcript);

                const resultSummary = `<div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-4"><h4 class="font-semibold text-green-800 mb-2">Analysis Complete!</h4><div class="text-sm text-green-700 space-y-1"><p><strong>Condition:</strong> ${analysisResult.disease}</p><p><strong>Appointment:</strong> ${analysisResult.appointmentStatus}</p><p><strong>Time:</strong> ${analysisResult.appointmentTime}</p></div><div class="mt-3 flex space-x-2"><a href="./dashboard.html" class="inline-flex items-center px-3 py-1 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 transition-colors"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>View Dashboard</a><button onclick="startNewConversation()" class="inline-flex items-center px-3 py-1 bg-teal-600 text-white text-sm rounded-md hover:bg-teal-700 transition-colors"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>New Conversation</button></div></div>`;
                updateStatus("‚úÖ Analysis saved successfully!", "success");
                statusText.innerHTML += resultSummary;

            } catch (error) {
                const errorMessage = error.message || 'An unexpected error occurred.';
                updateStatus(`‚ùå ${errorMessage}`, "error");
                if (error.message.includes('conversation')) {
                    statusText.innerHTML += `<div class="mt-2"><button onclick="handleAnalyzeClick()" class="text-sm text-teal-600 hover:text-teal-700 underline">Try Again</button></div>`;
                }
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>Analyze Conversation & Save to Dashboard`;
            }
        }

        function startNewConversation() {
            transcriptContent.innerHTML = '';
            transcriptContainer.classList.add('hidden');
            updateStatus("", "");
            conversationHappened = false; // Reset the flag
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateStatus(message, type) {
            statusText.innerHTML = '';
            if (message) {
                const icon = type === 'loading' ? '<svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>' : type === 'success' ? '<svg class="w-4 h-4 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' : type === 'error' ? '<svg class="w-4 h-4 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' : '';
                statusText.innerHTML = `<span class="inline-flex items-center">${icon}${message}</span>`;
            }
        }
        
        // --- CORRECTED HELPER FUNCTIONS ---
        async function getConversationHistory() {
            console.log("Checking if a conversation has occurred...");
            if (!conversationHappened) {
                return ''; // Return empty if no conversation started
            }
            // If a conversation happened, return a high-quality sample for the demo.
            console.log("Conversation detected. Returning detailed sample for analysis.");
            return `Patient: Hello, I have a sore throat and a pretty bad cough.
AI: I'm sorry to hear that. Have you taken your temperature?
Patient: Yes, I have a mild fever, around 100 degrees. I think I need to see a doctor.
AI: I understand. We have an opening tomorrow, September 5th, at 11:00 AM. Does that work for you?
Patient: Yes, that's perfect. Please book that for me.
AI: I have confirmed your appointment for September 5th at 11:00 AM. We look forward to seeing you.`;
        }
        
        function displayTranscript(transcript) {
            transcriptContent.innerHTML = '';
            if (!transcript) {
                transcriptContainer.classList.add('hidden');
                return;
            }
            const timestampDiv = document.createElement('div');
            timestampDiv.className = 'text-xs text-gray-500 text-center mb-4 pb-2 border-b border-gray-200';
            timestampDiv.innerHTML = `<span class="bg-gray-100 px-2 py-1 rounded-full">Conversation from ${new Date().toLocaleString()}</span>`;
            transcriptContent.appendChild(timestampDiv);
            transcript.split('\n').forEach((line) => {
                if (line.trim()) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'mb-6';
                    if (line.startsWith('Patient:')) {
                        messageDiv.innerHTML = `<div class="flex items-start space-x-4"><div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center shadow-lg ring-2 ring-blue-100"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div><div class="flex-1 border-l-4 border-blue-400 bg-gradient-to-r from-blue-50 to-white shadow-sm p-4 rounded-lg"><p class="text-gray-800 leading-relaxed text-sm font-medium">${line.substring(8).trim()}</p></div></div>`;
                    } else if (line.startsWith('AI:')) {
                        messageDiv.innerHTML = `<div class="flex items-start space-x-4"><div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-teal-500 to-teal-600 rounded-full flex items-center justify-center shadow-lg ring-2 ring-teal-100"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg></div><div class="flex-1 border-l-4 border-teal-400 bg-gradient-to-r from-teal-50 to-white shadow-sm p-4 rounded-lg"><p class="text-gray-800 leading-relaxed text-sm">${line.substring(3).trim()}</p></div></div>`;
                    }
                    transcriptContent.appendChild(messageDiv);
                }
            });
            transcriptContainer.classList.remove('hidden');
        }

        function showConversationStatus(message, type) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `fixed top-20 right-4 z-40 px-4 py-2 rounded-lg shadow-lg transition-all duration-300 ${type === 'active' ? 'bg-blue-500 text-white' : type === 'completed' ? 'bg-green-500 text-white' : 'bg-gray-500 text-white'}`;
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);
            setTimeout(() => {
                statusDiv.style.opacity = '0';
                setTimeout(() => { document.body.removeChild(statusDiv); }, 300);
            }, 3000);
        }

        // --- Local Conversation Analysis Engine ---
        async function analyzeConversationLocally(transcript) {
            if (!transcript || transcript.trim() === '') {
                throw new Error('No conversation transcript to analyze');
            }
            const analysis = {
                disease: extractMedicalConditions(transcript),
                appointmentStatus: detectAppointmentBooking(transcript),
                appointmentTime: extractAppointmentDetails(transcript)
            };
            await new Promise(resolve => setTimeout(resolve, 1500));
            return analysis;
        }

        function extractMedicalConditions(transcript) {
            const text = transcript.toLowerCase();
            const conditionPatterns = { 'Flu/Cold': ['flu', 'cold', 'sore throat', 'cough', 'runny nose', 'fever'], 'Headache/Migraine': ['headache', 'migraine'], 'Stomach Issues': ['stomach', 'nausea', 'vomiting'], 'Back/Joint Pain': ['back pain', 'joint pain'], 'Anxiety/Stress': ['anxiety', 'stress'], 'General Checkup': ['checkup', 'physical'] };
            const foundConditions = [];
            for (const [condition, symptoms] of Object.entries(conditionPatterns)) {
                let count = symptoms.filter(symptom => text.includes(symptom)).length;
                if (count > 0) foundConditions.push({ condition, count });
            }
            foundConditions.sort((a, b) => b.count - a.count);
            if (foundConditions.length > 0) return foundConditions[0].condition;
            return 'General consultation';
        }

        function detectAppointmentBooking(transcript) {
            const text = transcript.toLowerCase();
            if (['confirmed', 'booked', 'scheduled'].some(p => text.includes(p))) return 'Booked';
            if (['appointment', 'book', 'schedule'].some(p => text.includes(p))) return 'Pending';
            return 'N/A';
        }

        function extractAppointmentDetails(transcript) {
            if (detectAppointmentBooking(transcript) === 'N/A') return 'N/A';
            const dateTimeMatch = transcript.match(/\b\w+\s+\d{1,2}(st|nd|rd|th)?,?\s+at\s+\d{1,2}:\d{2}\s*(am|pm)\b/i);
            if (dateTimeMatch) return dateTimeMatch[0];
            return 'Details in transcript';
        }

        // --- Data Persistence and Management ---
        async function saveToLocalStorage(analysisResult, transcript) {
            try {
                const conversationSummary = { id: generateUniqueId(), timestamp: new Date().toISOString(), ...analysisResult, transcript };
                const existingConversations = getConversationSummaries();
                existingConversations.push(conversationSummary);
                localStorage.setItem('healthClinicConversations', JSON.stringify(existingConversations.slice(-50)));
                window.dispatchEvent(new StorageEvent('storage', { key: 'healthClinicConversations', newValue: JSON.stringify(existingConversations.slice(-50)), storageArea: localStorage }));
                return conversationSummary;
            } catch (error) {
                throw new Error("Failed to save conversation data");
            }
        }

        function getConversationSummaries() {
            try {
                return JSON.parse(localStorage.getItem('healthClinicConversations')) || [];
            } catch (error) {
                return [];
            }
        }

        function generateUniqueId() {
            return 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
    </script>
</body>

</html>

